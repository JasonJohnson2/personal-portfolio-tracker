function corsHeaders(){return {'content-type':'application/json; charset=utf-8','access-control-allow-origin':'*','access-control-allow-headers':'content-type, authorization','access-control-allow-methods':'GET, POST, OPTIONS'};}
type Env={PORTFOLIO_DB:D1Database;ALPACA_KEY_ID:string;ALPACA_SECRET_KEY:string};
async function getEquityPrice(s:string,env:Env){if(!env.ALPACA_KEY_ID||!env.ALPACA_SECRET_KEY)return null;const r=await fetch(`https://data.alpaca.markets/v2/stocks/${encodeURIComponent(s)}/snapshot`,{headers:{'APCA-API-KEY-ID':env.ALPACA_KEY_ID,'APCA-API-SECRET-KEY':env.ALPACA_SECRET_KEY}});if(!r.ok)return null;const d=await r.json();return d?.latestTrade?.p??null;}
const COIN_ID_MAP:Record<string,string>={BTC:'bitcoin',ETH:'ethereum',SOL:'solana'};
async function getCryptoPrice(pair:string){const[a,f='USD']=pair.split('-');const id=COIN_ID_MAP[a?.toUpperCase?.()]||null;if(!id)return null;const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=${f.toLowerCase()}`);if(!r.ok)return null;const d=await r.json();return d?.[id]?.[f.toLowerCase()]??null;}
export const onRequestOptions: PagesFunction<Env> = async ()=> new Response(null,{headers:corsHeaders()});
export const onRequestPost: PagesFunction<Env> = async (ctx)=>{try{const b=await ctx.request.json();const{watchlistId,minPrice=null,maxPrice=null}=b||{};if(!watchlistId)return new Response(JSON.stringify({'error':'Missing watchlistId'}),{status:400,headers:corsHeaders()});const rs=await ctx.env.PORTFOLIO_DB.prepare(`SELECT symbol FROM watchlist_symbols WHERE watchlist_id=?1`).bind(watchlistId).all();const symbols=(rs.results??[]).map((r:any)=>r.symbol);const hits:any[]=[];for(const s of symbols){const price=s.includes('-')?await getCryptoPrice(s):await getEquityPrice(s,ctx.env as any);if(price==null)continue;const passMin=(minPrice==null)||price>=minPrice;const passMax=(maxPrice==null)||price<=maxPrice;if(passMin&&passMax)hits.push({symbol:s,price});}return new Response(JSON.stringify(hits),{headers:corsHeaders()});}
catch(e){return new Response(JSON.stringify({'error':String(e)}),{status:500,headers:corsHeaders()})}};
