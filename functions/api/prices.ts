function corsHeaders(){return {'content-type':'application/json; charset=utf-8','access-control-allow-origin':'*','access-control-allow-headers':'content-type, authorization','access-control-allow-methods':'GET, POST, OPTIONS'};}
type Env={ALPACA_KEY_ID:string;ALPACA_SECRET_KEY:string};
export const onRequestOptions: PagesFunction<Env> = async ()=> new Response(null,{headers:corsHeaders()});
async function getEquityPrice(s:string,env:Env){if(!env.ALPACA_KEY_ID||!env.ALPACA_SECRET_KEY)return null;const r=await fetch(`https://data.alpaca.markets/v2/stocks/${encodeURIComponent(s)}/snapshot`,{headers:{'APCA-API-KEY-ID':env.ALPACA_KEY_ID,'APCA-API-SECRET-KEY':env.ALPACA_SECRET_KEY}});if(!r.ok)return null;const d=await r.json();return d?.latestTrade?.p??null;}
const COIN_ID_MAP:Record<string,string>={BTC:'bitcoin',ETH:'ethereum',SOL:'solana'};
async function getCryptoPrice(pair:string){const[a,f='USD']=pair.split('-');const id=COIN_ID_MAP[a?.toUpperCase?.()]||null;if(!id)return null;const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=${f.toLowerCase()}`);if(!r.ok)return null;const d=await r.json();return d?.[id]?.[f.toLowerCase()]??null;}
export const onRequestGet: PagesFunction<Env> = async (ctx)=>{const u=new URL(ctx.request.url);const syms=(u.searchParams.get('symbols')||'').split(',').map(s=>s.trim()).filter(Boolean);const out:Record<string,number|null>{};for(const s of syms)out[s]=s.includes('-')?await getCryptoPrice(s):await getEquityPrice(s,ctx.env);return new Response(JSON.stringify(out),{headers:corsHeaders()});};
